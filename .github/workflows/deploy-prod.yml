name: Deploy Production to Cloudflare Pages

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to deploy (format: vX.Y.Z)"
        required: true
        type: string

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
      VITE_APP_URL: ${{ secrets.VITE_APP_URL_PROD }}
    steps:
      - name: Checkout tag commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref }}

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Ensure selected tag is newest SemVer tag
        id: tag_check
        shell: bash
        run: |
          set -euo pipefail
          CURRENT_TAG="${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}"
          if ! [[ "$CURRENT_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Tag $CURRENT_TAG does not match required format vX.Y.Z"
            exit 1
          fi

          LATEST_TAG="$(git tag -l | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1)"
          if [[ -z "$LATEST_TAG" ]]; then
            echo "No SemVer tags found in repository."
            exit 1
          fi

          if [[ "$CURRENT_TAG" != "$LATEST_TAG" ]]; then
            echo "Skipping deploy: current tag $CURRENT_TAG is not newest SemVer tag $LATEST_TAG."
            echo "should_deploy=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Deploying newest SemVer tag: $CURRENT_TAG"
          echo "should_deploy=true" >> "$GITHUB_OUTPUT"

      - name: Setup Bun
        if: steps.tag_check.outputs.should_deploy == 'true'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        if: steps.tag_check.outputs.should_deploy == 'true'
        run: bun install --frozen-lockfile

      - name: Build
        if: steps.tag_check.outputs.should_deploy == 'true'
        run: bun run build

      - name: Deploy to Cloudflare Pages (production)
        if: steps.tag_check.outputs.should_deploy == 'true'
        run: bunx wrangler pages deploy dist --project-name better-being-prod
